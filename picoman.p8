pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
function _init()
	plr={}
	plr.x=64
	plr.y=58
	plr.w=5
	plr.h=5
	plr.hw=plr.w/2
	plr.hh=plr.h/2
	plr.mvivl=2
	plr.mvf=0
	plr.sp=1
	plr.spivl=2
	plr.spf=plr.spivl
	plr.cdir=0
	plr.sdir=0
	plr.xfl=false
	plr.yfl=false
	plr.tlx,plr.tly=0,0
	plr.trx,plr.try=0,0
	plr.blx,plr.bly=0,0
	plr.brx,plr.bry=0,0
	
	wld={}
	wld.ox=11
	wld.oy=1
	wld.cw=20
	wld.ch=20
	wld.cszx=5 --cell size
	wld.cszy=5
	wld.boundl=wld.ox+
		wld.cszx-
		plr.hw
	wld.boundr=wld.ox+
		wld.cw*wld.cszx+
		plr.hw
		
	dots={}
	for x=1,wld.cw-1 do
		for y=0,wld.ch do
			local m=mget(x,y)
			if not fget(m,0) and
				not fget(m,2)
			then
				local wx,wy=
					cell_to_world(x,y)
				add(dots,{
					x=wx+2,y=wy+2,
					hide=false
				})
			end
		end
	end
	
	local n=#dots
	for i=1,n do
		for j=i+1,n do
			local dx=dots[i].x-dots[j].x
			local dy=dots[i].y-dots[i].y
			dx,dy=abs(dx),abs(dy)
			
		end
	end
end

function _update60()
	for i=0,3 do
		local c=btn_cdir(i)
		if btn(i) and
			plr_clear(plr,c)
		then
			plr.cdir=c
			break
		end
	end
	
	plr.mvf-=1
	if plr.mvf<=0 then
		plr.mvf=plr.mvivl
		plr_move(plr)
	end

	if plr.cdir>0 then	
		plr.sdir=plr.cdir
 	plr.spf-=1
 	if plr.spf<=0 then
 		plr.spf=plr.spivl
 		plr.sp+=1
 		if (plr.sp>4) plr.sp=1
 	end
 else
 	plr.spf=plr.spivl
 	plr.sp=1
 end
end

function _draw()
	cls()
	ox=wld.ox
	oy=wld.oy
	for x=1,wld.cw-1 do
		for y=0,wld.ch do
			local m=mget(x,y)
			if m>0 then
				spr(m,x*wld.cszx+ox,
					y*wld.cszy+oy)
			end
		end
	end
	
	for i=1,#dots do
		local d=dots[i]
		pset(d.x,d.y,10)
	end

	local sp=plr.sp
	if plr.sdir>0 and 
		plr.sdir%2==0
	then
		sp+=4
	end
	
	local xfl,yfl=false,false
	
	if (plr.sdir==2) yfl=true
	if (plr.sdir==3) xfl=true
	
	local ox,oy=-2,-2
	if (xfl) ox-=3
	if (yfl) oy-=3
	
	spr(sp,plr.x+ox,plr.y+oy,
		1,1,
		xfl,yfl)
	
	rectfill(0,0,wld.boundl+2,127,0)
	rectfill(wld.boundr-2,0,127,127,0)	
	
	print(plr.x..","..plr.y,0,122,7)
end

function
plr_clear(plr,cdir,dx,dy)
	local xx,yy=cdir_to_dir(cdir)
	dx=dx or xx
	dy=dy or yy

	local lx,ly=0,0
	local rx,ry=0,0
	
	if cdir==0 then
		return true
	elseif cdir==1 then
		lx,ly=plr.trx,plr.try
		rx,ry=plr.brx,plr.bry
	elseif cdir==2 then
		lx,ly=plr.tlx,plr.tly
		rx,ry=plr.trx,plr.try
	elseif cdir==3 then
		lx,ly=plr.blx,plr.bly
		rx,ry=plr.tlx,plr.tly
	elseif cdir==4 then
		lx,ly=plr.brx,plr.bry
		rx,ry=plr.blx,plr.bly
	else
		return true
	end
	
	lx+=dx
	ly+=dy
	rx+=dx
	ry+=dy
	
	return not point_solid(lx,ly)
		and not point_solid(rx,ry)
end

function plr_move(plr)
	local dx,dy=cdir_to_dir(
		plr.cdir)
	
	if not plr_clear(plr,plr.cdir)
	then
		plr.cdir=0
		dx=0
		dy=0
	end
	
	plr.x+=dx
	plr.y+=dy
	
	if dx>0 and plr.x>=wld.boundr
	then
		plr.x=ceil(wld.boundl)
	elseif dx<0 and plr.x<=wld.boundl
	then
		plr.x=ceil(wld.boundr-1)
	end
	
	plr.tlx=plr.x-plr.hw+1
	plr.tly=plr.y-plr.hh+1
	
	plr.blx=plr.x-plr.hw+1
	plr.bly=plr.y+plr.hh

	plr.trx=plr.x+plr.hw
	plr.try=plr.y-plr.hh+1

	plr.brx=plr.x+plr.hw
	plr.bry=plr.y+plr.hh
end

_cdir_tbl={
	{x=0,y=0},
	{x=1,y=0},
	{x=0,y=-1},
	{x=-1,y=0},
	{x=0,y=1},
}
function cdir_to_dir(cdir)
	local v=_cdir_tbl[cdir+1]
	return v.x,v.y
end

function point_solid(x,y)
	local cx,cy=world_to_cell(x,y)
	return cell_solid(cx,cy)
end

function world_to_cell(wx,wy)
	return (wx-wld.ox)/wld.cszx,
		(wy-wld.oy)/wld.cszy
end

function cell_to_world(cx,cy)
	return cx*wld.cszx+wld.ox,
		cy*wld.cszy+wld.oy
end

function cell_solid(cx,cy)
	return fget(mget(cx,cy),0)
end

_btn_cdir={3,1,2,4}
function btn_cdir(b)
	return _btn_cdir[b+1]
end
__gfx__
000000000aaa00000aaa00000aaa00000aaa00000aaa00000aaa00000aaa00000aaa000000000000000000000000000000000000000000000000000000000000
00000000aaaaa000aaaa0000aaa00000aaaa0000aaaaa000aaaaa000aaaaa000aaaaa00000000000000000000000000000000000000000000000000000000000
00700700aaaaa000aaa00000aa000000aaa00000aaaaa000aaaaa000aa0aa000aaaaa00000000000000000000000000000000000000000000000000000000000
00077000aaaaa000aaaa0000aaa00000aaaa0000aaaaa000aa0aa000a000a000aa0aa00000000000000000000000000000000000000000000000000000000000
000770000aaa00000aaa00000aaa00000aaa00000aaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
c000c000ccccc000ccccc000ccccc000ccccc000c000c000ccccc000c000c000c000c000ccccc000ccccc000c000c000c000c000c000c000ccccc000c0000000
c000c000000000000000c000c0000000c000c000c000c000c0000000c00000000000c0000000c00000000000c0000000000000000000c000c0000000c0000000
c000c000000000000000c000c0000000c000c000c000c000c0000000c00000000000c0000000c00000000000c0000000000000000000c000c0000000c0000000
c000c000000000000000c000c0000000c000c000c000c000c0000000c00000000000c0000000c00000000000c0000000000000000000c000c0000000c0000000
c000c000ccccc000ccccc000ccccc000c000c000ccccc000c000c000ccccc000ccccc000c000c000c000c000c000c000ccccc000c000c000c0000000ccccc000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000c000ccccc000c00000000000c000ccccc0000000000022222000000000000000000000000000000000000000000000000000000000000000000000000000
0000c0000000c000c00000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000c0000000c000c00000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000c0000000c000c00000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ccccc0000000c000c00000000000c00000000000ccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000001010101010101010101010101010101010101010101030000000000000004010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
2f1611111111111111111a1111111111111111192f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f100000000000000000100000000000000000102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f100013120013111200150013111200131200102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f100000000000000000000000000000000000102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f1000131200140013111a1112001400131200102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f100000000010000000100000001000000000102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f1b111119001b11122e152e13111d001611111d2f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f102f2f1000102e2e2e2e2e2e2e1000102f2f102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f1711111800152e1e242624212e1500171111182f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
002e2e2e2e002e2e222e2e2e232e2e002e2e2e2e2f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f1611111900142e1f252525202e1400161111192f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f102f2f1000102e2e2e2e2e2e2e1000102f2f102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f1b11111800152e13111a11122e15001711111d2f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f100000000000000000100000000000000000102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f100013190013111200150013111200161200102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f100000100000000000000000000000100000102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f1b12001500140013111a11120014001500131d2f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f100000000010000000100000001000000000102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f10001311111c111200150013111c11111200102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f100000000000000000000000000000000000102f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2f171111111111111111111111111111111111182f0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
