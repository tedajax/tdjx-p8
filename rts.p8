pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
	poke(0x5f2d,1)

	units={}
	selection={}
	
	for i=1,10 do
		add_unit(1,
			4+flr(rnd(8)),
			4+flr(rnd(8)))
	end
--	add_unit(1,8,8)
	
	mou_x,mou_y,mou_b,
	mou_px,mou_py,mou_pb=
		0,0,0,0,0,0

	sel_box_x1,sel_box_y1,
	sel_box_x2,sel_box_y2=-1,-1,-1,-1
end

function _update60()
	mou_px,mou_py,mou_pb=mou_x,mou_py,mou_b
	mou_x=stat(32)
	mou_y=stat(33)
	mou_b=stat(34)
	
	local dx,dy=
		mou_x-mou_px,
		mou_y-mou_py
	
	for i=1,5 do
		local b=band(mou_b,shl(1,i-1))~=0
		local pb=band(mou_pb,shl(1,i-1))~=0
		if b and not pb then
			mou_down(i)
		elseif not b and pb then
			mou_up(i)
		elseif b and pb and 
			(dx~=0 or dy~=0)
		then
			mou_drag(i,dx,dy)
		end
	end
end

function mou_down(b)
	if b==1 then
		sel_box_x1,sel_box_y1,
		sel_box_x2,sel_box_y2=
			mou_x,mou_y,mou_x,mou_y
	end
end

function mou_up(b)
	if b==1 then
		select(sel_box_x1,sel_box_y1,
			sel_box_x2,sel_box_y2)
	
		sel_box_x1,sel_box_y1,
		sel_box_x2,sel_box_y2=-1,-1,-1,-1
	end
end

function mou_drag(b,dx,dy)
	sel_box_x2,sel_box_y2=
		mou_x,mou_y
end

function select(x1,y1,x2,y2)
	selection={}

	for unit in all(units) do
		local ux1,uy1,ux2,uy2=
			extents(unit)
		
		if intersect(x1,y1,x2,y2,
			ux1,uy1,ux2,uy2)
		then
			add(selection,unit)
		end
	end
end

function intersect(ax1,ay1,ax2,ay2,bx1,by1,bx2,by2)
	return ax1<=bx2 and
		ax2>=bx1 and
		ay1<=by2 and
		ay2>=by1
end

function extents(r)
	return (r.x-r.w)*8,
		(r.y-r.h)*8,
		(r.x+r.w)*8-1,
		(r.y+r.h)*8-1
end

function _draw()
	cls()

	-- game camera
	
	map(0,0,0,0,16,16)
	
	foreach(units,function(self)
		spr(self.sp,
			self.x*8-self.w*8,
			self.y*8-self.h*8,
			self.sw,self.sh)
	end)
	
	foreach(selection,function(self)
		local x1,y1,x2,y2=extents(self)
		rect(x1,y1,x2,y2,10)
	end)
	
	-- ui camera
		
	pset(stat(32),stat(33),11)
	if sel_box_x1>=0 and
		sel_box_y1>=0
	then
		rect(sel_box_x1,sel_box_y1,
			sel_box_x2,sel_box_y2,
			11)
	end
end

function add_unit(utype,x,y)
	local sp=0
	if utype==1 then
		sp=16
	end

	return add(units,{
		utype=utype or 0,
		x=x or 0,
		y=y or 0,
		w=0.5,h=0.5,
		tx=x or 0,ty=y or 0,
		sp=sp,sw=1,sh=1,
	})
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00cccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c1111c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0cd11dc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c1111c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c1dd1c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00cccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f4444fff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffff4fff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4ffff444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4fffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
3030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030203030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303020202020203020303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030302020202020203030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030302030202020303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030302020303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030302030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030302030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
