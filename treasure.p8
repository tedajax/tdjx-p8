pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
#include util.p8

entity=class({
	x=0,y=0,w=4,h=4,
})

player=class({
	extends=entity,
	id=0,
})

mapentity=class({
	extends=entity,
	mx=0,my=0,
})

door=class({
	extends=mapentity,
	down_ct=0,
})

switch=class({
	extends=mapentity,
	target=nil,
	down_ct=0,
	on_enter=function(self,other)
		self.down_ct+=1
		mset(self.mx,self.my,33)
	end,
	on_exit=function(self,other)
		self.down_ct-=1
		if self.down_ct==0 then
			mset(self.mx,self.my,32)
		end
	end,
})

function player:on_update(dt)
	local ix,iy=input_xy(self.id)
	
	local speed=30*dt
	self.x+=ix*speed
	self.y+=iy*speed
end

k_pcols={12,8}
function player:on_draw()
	local x,y=topleft(self)
	pal(7,k_pcols[self.id+1])
	spr(1,x,y)
	pal()
end

function _init()
	entities={}
	
	local pid=0
	
	for x=0,15 do
		for y=0,15 do
			local m=mget(x,y)
			if m==1 then
				add(entities,player:new({
					id=pid,
					x=x*8+4,
					y=y*8+4,
				}))
				pid+=1
				mset(x,y,0)
			elseif m==17 then
				add(entities,door:new({
					mx=x,my=y,
					x=x*8+4,y=y*8+4,
					w=4,h=4,
				}))
			elseif m==32 then
				add(entities,switch:new({
					mx=x,my=y,
					x=x*8+4,y=y*8+4,
					w=4,h=4,
				}))
			end
		end
	end
end

function _update()
	dt=fps30_dt

	local n=#entities
	
	for i=1,n do
		local e=entities[i]
		if e.on_update then
			e:on_update(dt)
		end
	end

end

function _draw()
	cls()
	
	map(0,0,0,0,16,16)
	
	foreach(entities,function(e)
		if (e.on_draw) e.on_draw(e)
	end)
end
__gfx__
00000000000770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700077777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700007777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000007007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9ff99ff9cddddddc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9ff99ff9cddddddc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999cddddddc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999cddddddc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9ff99ff9cddddddc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9ff99ff9cddddddc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999cccccccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00cccc00000dd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00dccd0000dddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001dd100005dd5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00011000000550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000200010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000010001000011000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000010002000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
