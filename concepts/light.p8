pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
function _init()
	load_palette(64,0)
	load_palette(65,1)

	px=64
	py=64
end

function _update()
	if(btn(0))px-=1
	if(btn(1))px+=1
	if(btn(2))py-=1
	if(btn(3))py+=1
end

function _draw()
	cls()
	map(0,0,0,0,16,16)

	srand()
	local u=t()/16
	for i=0,20 do
		local r=rnd()
		spr(3,64+cos(u+r)*sin(u+rnd())*64,
			sin(u+r)*sin(u+rnd())*64)
	end

	light_circ(px,py,36)
	
	print("fps:"..stat(7),0,0,11)
	print("cpu:"..stat(1),0,6,11)
	print("pos:"..px..","..py,0,12,11)
	
	draw_log()
end

function light_circ(lx,ly,ldist)
	local ltop=mid(0,ly-ldist,127)
	local lbot=mid(127,ly+ldist,0)
	
	if ltop>0 then
		memset(0x6000,0,ltop*64)
	end
	
	if lbot<127 then
		memset(bor(0x6000,(lbot+1)*64),
			0,(127-lbot)*64)
	end
	
	local l,r=lx-ldist,lx+ldist
	
	for y=ltop,lbot do
		light_hline(y,lx,ly,ldist,l,r)
		
		local sladr=bor(0x6000,y*64)
		if l>0 then
			memset(sladr,0,flr(l/2))
		end
		if r<127 then
			local ro2=flr(r/2)
			memset(sladr+ro2,0,64-ro2)
		end
	end
end

-- 1 palette
-- 256 bytes per light level
-- 8 light levels
-- 2048 bytes
-- 3 palettes fit in 0x4300 space
function palette_adr(pi)
	return 0x4300+(pi or 0)*0x800
end

-- sp: sprite to load palette from
-- reads two sprites vertically
-- pi: palette index to write to
--	[0,2]
function load_palette(sp,pi)
	paladr=palette_adr(pi)
	
	local sx=(sp%16)*8
	local sy=flr(sp/16)*8
	
	for li=0,7 do
		for l=0,15 do
			local lc=sget(sx+li,l+sy)
			for r=0,15 do
				local adr=paladr+li*0x100+l*0x10+r
				local rc=sget(sx+li,r+sy)
				local byte=bor(shl(lc,4),rc)
				poke(adr,byte)
			end
		end
	end
end

function palette_value(pi,val,li)
	return peek(
		palette_adr(pi)+val*8+li)
end

_ll_tbl={
	0,0,0,0,0,0,0,0,
	0,0,0,0,1,1,1,1,
	1,1,1,1,2,2,2,2,
	3,3,3,4,4,4,5,5,
}

function light_hline(y,lx,ly,rad,x1,x2)
	--light_hline_slow(y,lx,ly,x1,x2)
	
	x1=x1 or 0
	x2=x2 or 127
	
	x1=max(x1,0)
	x2=min(x2,127)
	
	local r2=rad*rad
	
	local l,r=flr(x1/2),flr(x2/2)
	
	for x=l,r do
		local dx=(x*2)-lx
		local dy=y-ly
		local d=(dx*dx+dy*dy)
		local li=min(flr(d/r2*32),31)
		local ll=_ll_tbl[li+1]
		local scradr=bor(0x6000,y*64+x)
		local pi=0
		local paladr=bor(0x4300+pi*0x800+
			ll*0x100,peek(scradr))
		poke(scradr,peek(paladr))		
	end

--[[	x1=flr(x1/2)
	x2=flr(x2/2)
	local s=y*64+x1
	local e=y*64+x2
	
	for adr=s,e do
		
	end]]
end

-->8
_logs={}

function log(msg,col)
	add(_logs,{msg=tostr(msg),col=col or 6})
	local n=#_logs
	if n>20 then
		for i=2,n do
			_logs[i-1]=_logs[i]
		end
		_logs[n]=nil
	end
end

function draw_log()
	local n=#_logs
	for i=1,n do
		local l=_logs[i]
		print(l.msg,127-#l.msg*4,(i-1)*6,l.col)
	end
end

-->8
-- 6k
-- 256 per level
-- 7*256=
__gfx__
0000000044444444d9a99a9d003bbb30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000a9aaa4a999aaaa9903bb9aa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700999a94a9aa9999aa03bbb9a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770009a9994999a9dd9a9003b3330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000444444449a9dd9a903bbb660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700a4a9aa9aaa9999aa03666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000094a99a9999aaaa990bb56650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000949999a9d9a99a9d03b003b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22110000211000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33311000331100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
42211000442210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55111000551100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66d5100066dd51000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
776d100077776d510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88221000888421000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
94221000999421000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a9421000aa9942100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bb331000bbb331000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ccd51000ccdd51000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd511000dd5110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ee421000ee4442100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f9421000fff942100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22110000211000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33311000331100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
42211000442210000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55111000551100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66d5100066dd51000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
776d100077776d510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88221000888421000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
94221000999421000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
a9421000aa9942100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bb331000bbb331000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ccd51000ccdd51000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd511000dd5110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ee421000ee4442100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
f9421000fff942100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
