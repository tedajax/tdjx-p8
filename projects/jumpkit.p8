pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
function _init()
	actors={}
	k_max_actors=32
	
	for x=0,127 do
		for y=0,63 do
			if mget(x,y)==48 then
				player=make_player(x,y+1,1)
			end
		end
	end
	
	cam_x=0
	cam_y=0
end

function _update()
	foreach(actors,move_actor)
	
	cam_x=mid(0,player.x*8-64,1024-128)
	cam_y=mid(0,player.y*8-64,512-128)
	
	btnpoll()
end

function _draw()
	cls()
	
	camera(cam_x,cam_y)
	map(0,0,0,0,128,64,1)
	
	foreach(actors,draw_actor)	
	
	camera()
	print(49+flr(player.f0),0,0,7)
end

function make_player(x,y,face)
	local pl=make_actor(x,y,face,"p1")
	pl.frame=6
	pl.controller=control_player
	pl.bounce=0
	pl.id=0
	return pl
end

function control_player(pl)
	accel=0.05
	
	if not pl.standing then
		accel*=0.5
	end
	
	if btn(0,pl.id) then
		pl.dx-=accel
		pl.face=-1
	end
	
	if btn(1,pl.id) then
		pl.dx+=accel
		pl.face=1
	end
	
	if btnp(4,pl.id) and pl.standing
	then
		pl.dy=-0.7
	end
	
	if pl.standing then
		pl.f0=(pl.f0+abs(pl.dx)*2+4)%4
	else
		pl.f0=(pl.f0+abs(pl.dx)/2+4)%4
	end
	
	if abs(pl.dx)<0.1 then
		pl.frame=6
		pl.f0=0
	else
--		pl.frame=49+flr(pl.f0)
	end
end

function make_actor(x,y,face,tag)
	local a={}
	a.tag=tag or "_"
	a.x=x or 63
	a.y=y or 15
	a.dx=0
	a.dy=0
	a.ddy=0.06 --gravity
	-- half-width/height
	a.w=0.3
	a.h=1
	a.face=face
	a.frame=1
	a.f0=0
	a.t=0
	a.standing=false
	a.controller=nil
	if #actors<k_max_actors then
		add(actors,a)
	end
	return a
end

function move_actor(a)
	if type(a.controller)==
		"function"
	then
		a:controller()
	end
	
	a.standing=false

	-- x movement
		
	x1=a.x+a.dx+sgn(a.dx)*0.3
	
	if not solid(x1,a.y-0.5) then
		-- didn't collide so move
		a.x+=a.dx
	else
		-- hit wall
		
		-- find contact point
		while not solid(
			a.x+sgn(a.dx)*0.3,
			a.y-0.5)
		do
			a.x+=sgn(a.dx)*0.1
		end
		
		-- bounce
		a.dx*=-0.5
		
		-- custom on collider callback	
	end
	
	-- y movement
	if a.dy<0 then
		-- going up
		if solid(a.x-0.2,a.y+a.dy-1) or
			solid(a.x+0.2,a.y+a.dy-1)
		then
			-- hit ceiling
			a.dy=0
			
			-- search for contact point
			while not solid(a.x-0.2,a.y-1)
				and not solid(a.x+0.2,a.y-1)
			do
				a.y-=0.01
			end
		else
			a.y+=a.dy
		end
	else
		-- going down
		if solid(a.x-0.2,a.y+a.dy) or
			solid(a.x+0.2,a.y+a.dy)
		then
			-- bounce
			if a.bounce>0 and
				a.dy>0.2
			then
				a.dy*=-a.bounce
			else
				a.standing=true
				a.dy=0
			end
			
			-- snap down
			while not solid(a.x-0.2,a.y)
				and not solid(a.x+0.2,a.y)
			do
				a.y+=0.05
			end
			
			-- pop up
			while solid(a.x-0.2,a.y-0.1)
			do
				a.y-=0.05
			end
			while solid(a.x+0.2,a.y-0.1)
			do
				a.y-=0.05
			end
		else
			a.y+=a.dy
		end
	end
	
	a.dy+=a.ddy
	a.dy*=0.95
	
	if a.standing then
		a.dx*=0.8
	else
		a.dx*=0.9
	end
	
	a.t+=1
end

function solid(x,y)
	if x<0 or x>=128 then
		return true
	end
	val=mget(x,y)
	return fget(val,0)
end

function draw_actor(a)
	spr(a.frame,a.x*8-4,a.y*8-a.h*8*2,
		1,2,a.face<0)
end

_btns={}
k_max_players=4
for p=0,k_max_players-1 do
	_btns[p]={}
	for b=0,5 do
		_btns[p][b]=false
	end
end

btnpd=btnp

function btnp(b,p)
	p=p or 0
	return btn(b,p) and
		not _btns[p][b]
end

function btnpoll()
	for p=0,k_max_players-1 do
		for b=0,5 do
			_btns[p][b]=btn(b,p)
		end
	end
end
__gfx__
000000006666666600000000000000000000000000000000ff00ff00000000000000000000000000000000000000000000000000000000000000000000000000
0000000065566556000000000000000000000000000000000ff00ff0000000000000000000000000000000000000000000000000000000000000000000000000
0070070065566556000000000000000000000000000000000f44f440000000000000000000000000000000000000000000000000000000000000000000000000
0007700066666666000000000000000000000000000000000f74f740000000000000000000000000000000000000000000000000000000000000000000000000
000770006666666600000000000000000000000000000000d4fffffd000000000000000000000000000000000000000000000000000000000000000000000000
007007006556655600000000000000000000000000000000dc4444cd000000000000000000000000000000000000000000000000000000000000000000000000
0000000065566556000000000000000000000000000000000dcccccd000000000000000000000000000000000000000000000000000000000000000000000000
0000000066666666000000000000000000000000000000000ddcccd0000000000000000000000000000000000000000000000000000000000000000000000000
006000600000000000000000000000000000000000000000088ddd80000000000000000000000000000000000000000000000000000000000000000000000000
00600060000000000000000000000000000000000000000008444440000000000000000000000000000000000000000000000000000000000000000000000000
06670667000000000000000000000000000000000000000084fff440000000000000000000000000000000000000000000000000000000000000000000000000
06670667000000000000000000000000000000000000000084000f40000000000000000000000000000000000000000000000000000000000000000000000000
067706770000000000000000000000000000000000000000f40000f4000000000000000000000000000000000000000000000000000000000000000000000000
667766770000000000000000000000000000000000000000f50000f4000000000000000000000000000000000000000000000000000000000000000000000000
66776677000000000000000000000000000000000000000050000050000000000000000000000000000000000000000000000000000000000000000000000000
67776777000000000000000000000000000000000000000050000050000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000e222e200e222e20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0e222e200e222e2002e222e002e222e00e222e200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02e222e002e222e0034646300346463002e222e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03464630034646300344443003444430034646300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
034444300344443000222dd000222000034444300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0022200000222dd00dd00000dd222000dd2220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00d0d00000d000000000000000000d000000d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00d0d00000d0000000000000000000d00000d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0003000000000000000000000000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000001000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000101010000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000010101010100000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101000000000000000000000000000000003000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101000001010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000001000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000001101001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000001010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
