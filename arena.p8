pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
	actors={}
	cam={x=0,y=0}
	world_init(0,0,32,16)
end

function _update()
	local ix,iy=0,0
	if (btn(0)) ix-=1
	if (btn(1)) ix+=1
	if (btn(2)) iy-=1
	if (btn(3)) iy+=1

	player.input={
		x=ix,y=iy,j=btnp(4)
	}

	for actor in all(actors) do
		actor:move()
	end
	
	cam.x=(player.x-8)*8
end

function _draw()
	cls()
	
	camera(cam.x,cam.y)
	map(world.x,world.y,0,0,world.w,world.h)
	
	for actor in all(actors) do
		actor:draw()
	end

	camera()
	
	dbg_draw()
end
-->8
actor={
	x=0,y=0,dx=0,dy=0,
	w=0.375,h=0.5,
	face=1,t0=0
}

function actor:new(props)
	self.__index=self
	return
		setmetatable(props or {},self)
end

function actor:move()
	self.dx=self.input.x*0.23
	
	if self.input.x~=0 then
		self.face=sgn(self.input.x)
	end
	
	if self.input.j then
		self.dy=-0.56
	end

	self.dy+=0.05
	
	local px=0.125
	local left,right=
		self.x-self.w,
		self.x+self.w-px
		
	local top,bot=
		self.y-self.h*2+px,
		self.y
	
	while self.dx>0 and
		(solid(right+self.dx,bot) or
			solid(right+self.dx,top))
	do
		self.dx=max(self.dx-px,0)
	end
	
	while self.dx<0 and
		(solid(left+self.dx,bot) or
			solid(left+self.dx,top))
	do
		self.dx=min(self.dx+px,0)
	end
		
	while self.dy>0 and
		(solid(left,bot+self.dy) or
			solid(right,bot+self.dy))
	do
		self.dy=max(self.dy-0.125,0)
	end
	
	while self.dy<0 and
		(solid(left,top+self.dy) or
			solid(right,top+self.dy))
	do
		self.dy=min(self.dy+0.125,0)
	end
	
	self.x+=self.dx
	self.y+=self.dy
	
	left,right=
		self.x-self.w,
		self.x+self.w-px
	self.ground=
		solid(left,self.y+px) or
		solid(right,self.y+px)
	
	self.t0=(self.t0+abs(self.input.x)*0.25)%4
	if self.input.x==0 then
		self.t0=0
	end
end

function actor:draw()
	local wx,wy=self.x,self.y
	wx-=0.5
	wy-=0.875
	wx*=8
	wy*=8
	local fx=self.face<0
	if self.ground then
		spr(self.kind+self.t0,wx,wy,1,1,fx)
	else
		local t=mid((self.dy+0.56)/0.56,0,1)
		
		spr(self.kind+16+t*3,wx,wy,1,1,fx)
	end
end

function make_actor(kind,param)
	param=param or {}
	param.kind=kind
	param.input={x=0,y=0,j=0}
	return add(actors,actor:new(param))
end
-->8
function solid(x,y)
	return fget(mget(x,y),0)
end

function world_init(x,y,w,h)
	world={x=x,y=y,w=w,h=h}

	for xx=x,x+w-1 do
		for yy=y,y+h-1 do
			if mget(xx,yy)==8 then
				player=make_actor(8,
					{x=xx+0.5,y=yy+1})
				mset(xx,yy,0)
			end
		end
	end
end
-->8
_dbg={
	watch={},
	log={}
}

function watch(msg,col)
	local m={
		msg=tostr(msg),
		col=col or 11
	}
	add(_dbg.watch,m)
end

function log(msg,col)
	local m={
		msg=tostr(msg),
		col=col or 7
	}
	add(_dbg.log,m)
	local n=#_dbg.log
	if n>20 then
		for i=1,20 do
			_dbg.log[i]=_dbg.log[i+1]
		end
		_dbg.log[21]=nil
	end
end

function dbg_draw()
	local n=#_dbg.watch
	for i=1,n do
		local w=_dbg.watch[i]
		print(w.msg,0,(i-1)*6,w.col)
	end
	
	local n=#_dbg.log
	for i=1,n do
		local l=_dbg.log[i]
		local len=#l.msg*4
		print(l.msg,127-len,(i-1)*6,l.col)
	end
	
	_dbg.watch={}
end
__gfx__
0000000000000000000000000000000000000000000000000000000000000000003b3b0000000000003b3b000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000d333300003b3b000d333300003b3b0000000000000000000000000000000000
0070070000000000000000000000000000000000000000000000000000000000dd3bbbd00d333300dd3bb3d00d33330000000000000000000000000000000000
0007700000000000000000000000000000000000000000000000000000000000dddbdddddd33bbd0dddbdddddd3bb3d000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000003dddddd3ddddbddd3dddddd3ddddbddd00000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000dddddd03dddddd30dddddd03dddddd300000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000033dd330033ddd3333dddd3333ddd33000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000003300330033ddd333300003333ddd33000000000000000000000000000000000
9999999900000000000000000000000000000000000000000000000000000000003b3b00003b3b000d3b3b000d3b3b0000000000000000000000000000000000
9999999900000000000000000000000000000000000000000000000000000000003333000d333300dd3333d0dd3333d000000000000000000000000000000000
99999999000000000000000000000000000000000000000000000000000000000d3bbbd0dd33bbd03d33bbdddd33b3dd00000000000000000000000000000000
9999999900000000000000000000000000000000000000000000000000000000dddbbbddddddddddddddddd33ddddddd00000000000000000000000000000000
9999999900000000000000000000000000000000000000000000000000000000dddbbddd3ddbdddd0ddddddd0dddddd300000000000000000000000000000000
99999999000000000000000000000000000000000000000000000000000000003ddddbd30dddbbd3033dd330033dd33000000000000000000000000000000000
9999999900000000000000000000000000000000000000000000000000000000033bd330033bd330033003300330033000000000000000000000000000000000
99999999000000000000000000000000000000000000000000000000000000000330033003300b30000b0b000000000000000000000000000000000000000000
__gff__
0000000000000000080000000000000001000000000000000808080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1010101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000008000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1000000010100000000000000000101010100000000000000000101000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
