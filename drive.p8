pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
	poke(0x5f2e,1)

	objects={}
	
	for i=1,25 do
		local w=0.66
		add(objects,{x=(i%2)*w*2-w+rnd(0.2)-0.1,y=0,z=25-i})
	end
end

function _update()
	foreach(objects,
		function(self)
			self.z-=0.15
			if self.z<0 then
				self.z+=25
				self.flag=1
			end
		end)
		
	for self in all(objects) do
		if self.flag==1 then
			move(objects,self,1)
			self.flag=0
			break
		end
	end
end

function move(arr,elem,idx)
	local n=#arr
	local found=nil
	for i=1,n do
		if arr[i]==elem then
			found=i
			break
		end
	end
	
	if not found then return end
	
	if found==idx then
		return
	elseif found>idx then
		for i=found-1,idx,-1 do
			arr[i+1]=arr[i]
		end
	elseif found<idx then
		for i=found+1,idx do
			arr[i-1]=arr[i]
		end
	end
	
	arr[idx]=elem
end

function _draw()
	pal(14,128+10,1)
	pal(15,128+11,1)
	cls(14)
	
	rectfill(0,0,127,64,12)
--	rectfill(0,65,127,127,15)
	
	-- mountains
	srand(33)
	for m=1,8 do
		local mx=rnd(128)
		local mh=16+rnd(44)
		local edge=-8+rnd(16)
		for x=-26,25 do
			local c=13
			if (x<edge) c=5
			line(mx,64-mh,mx+x,64,c)
		end
	end
	
	for x=-26,25 do
		local i=(x+26)/51
		local xx=7*i+-4
		line(x+64,127,64+xx,65,5)
	end
	for i=1,8 do
		local y=65+((i*8+t()*64)%63)
--		line(64,y,64,y+3,7)
	end
	
	foreach(objects,
		function(self)
			spr3d(self.x,self.y,self.z,
				32,2,2)
		end)
		
	-- car
	spr(1,64-8+sin(t()/3)*4,96+cos(t()/6.3)*2,2,2)
		
--	print(band(stat(1)*100,0xff).."%",0,0)
--	print(band(stat(2)*100,0xff).."%",0,6)
end

function spr3d(x,y,z,sp,sw,sh)
	if z<0.1 or z>15 then
		return
	end

	sp=sp or 0
	sw=sw or 1
	sh=sh or 1
	
	-- sprite sheet sprite coordinates
	local sx=sp%16
	local sy=flr(sp/16)
	
	-- sprite sheet pixel coordinates
	local spx=sx*8
	local spy=sy*8
	
	local spw=sw*8
	local sph=sh*8
	
	local hw=0.5--sw/2
	local hh=0.5--sh/2

	local wx0,wy0=(x-hw)/z,
		(y-hh)/z
	local wx1,wy1=(x+hw)/z,
		(y+hh)/z
	
	local tx=function(w)
		return w*64+64
	end
	
	local scrx0,scry0=tx(wx0),tx(wy0)
	local scrx1,scry1=tx(wx1),tx(wy1)
	
	local scrw=scrx1-scrx0
	local scrh=scry1-scry0

	sspr(spx,spy,spw,sph,
		scrx0,scry0,scrw,scrh)
end
__gfx__
00000000000000088000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000899800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000008999980000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000000889dd988000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000770000000889dd988000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000889988998800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000899888899800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000999888899900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000899dddddd9980000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000089dddddddd980000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000899dddddddd998000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000089dddddddddd98000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000899888888888899800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000999888888888899900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000999988888888999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000066600000000666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000003f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000bf00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000ffb30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000f3bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000033bbf3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000f3fbbf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000b33ffbf300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000bbbff3ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000f3fbbfbbff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000f3fffffbbf0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0003f3fff3fbbf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0033ffffffffbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
033ff33ffffffbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0f333ff33fbb3ff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
