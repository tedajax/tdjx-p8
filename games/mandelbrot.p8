pico-8 cartridge // http://www.pico-8.com
version 17
__lua__
function _init()
	cls()

	for sx=0,127 do
		for sy=0,127 do
			sset(sx,sy,0)
		end
	end
	
	scanlines={}
	scan_size=2
	for i=0,127,scan_size do
		add(scanlines,i)
	end
	
	local n=#scanlines
	local copy={}

	local cur=flr(n/2)
	local dist=0
	local idx=1
	while dist<n do
		for i=-1,1,2 do
			cur+=dist*i
			copy[idx]=scanlines[cur]
			dist+=1
			idx+=1
		end
	end
	
	for i=1,n do
		scanlines[i]=copy[i]
	end

--	shuffle(scanlines)

	zoom=1
	focusx=0
	focusy=0
	maxiter=30
	
	colors={5,6,7,6}
	
	mandel_cr=nil
	start_mandelbrot()
end

function _update()
	if mandel_cr then
		if costatus(mandel_cr)~="dead" then
			coresume(mandel_cr)
		else
			//zoom+=zoom*0.1
			//start_mandelbrot()
		end
	end

	if btnp(0) then
		focusx-=0.1
		start_mandelbrot()
	end
	
	if btnp(1) then
		focusx+=0.1
		start_mandelbrot()
	end
	
	if btnp(2) then
		focusy-=0.1
		start_mandelbrot()
	end
	
	if btnp(3) then
		focusy+=0.1
		start_mandelbrot()
	end
	
	if btnp(4) then
		zoom+=0.1
		start_mandelbrot()
	end
	
	if btnp(5) then
		zoom-=0.1
		start_mandelbrot()
	end
end

function _draw()
	--sspr(0,0,128,128)
end

function start_mandelbrot()
--	shuffle(scanlines)
	mandel_cr=cocreate(calc_mandel_view)
end

function calc_mandel_view()
	local invz=2/zoom
	local minx,maxx=
		focusx-invz,
		focusx+invz
	local miny,maxy=
		focusy-invz,
		focusy+invz
		
	local xscl,yscl=
		(maxx-minx)/127,
		(maxy-miny)/127
		
	local mandel=function(x,y)
		return mandelbrot(
			minx+xscl*x,
			miny+yscl*y,
			maxiter)
	end

	local n=#scanlines
	for sl=1,n do
		local sly=scanlines[sl]
		for y=sly,sly+scan_size-1 do
			local x=0
			while x<128 do
				local curr_mi=mandel(x,y)
				local mi=curr_mi
				local xx=x
				while xx<128 and
					mi~=curr_mi
				do
					xx+=1
					mi=mandel(xx,y)
				end
				
				local col=0
				if curr_mi<maxiter-1 then
					col=colors[curr_mi%#colors+1]
				end

				rectfill(x,y,xx-1,y,col)

				x=xx+1
			end
		end
	 yield()
--	 wait_sec(1)
	end
end

function mandelbrot(real,imag,miter)
	local zreal=0
	local zimag=0
	
	for i=1,miter do
		local t=zreal
		zreal=(zreal*zreal)-(zimag*zimag)
		zimag*=2*t
		zreal+=real
		zimag+=imag
		
		if zreal*zreal+zimag*zimag>=4 then
			return i-1
		end
	end
	
	return miter-1
end

function shuffle(a)
	local n=#a
	for i=n,2,-1 do
		local j=flr(rnd(i))+1
		a[i],a[j]=a[j],a[i]
	end
end

function wait_sec(sec)
	sec=sec or 0
	local start=t()
	while t()<start+sec do
		yield()
	end
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
55555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555666666666666666666666655555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555566666666666666666666666666666666555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555566666666666666666666666666666666666666555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555566666666666666666666666666666666666666666666555555555555555555555555555555555555555555
55555555555555555555555555555555555555566666666666666666666666666666666666666666666666666555555555555555555555555555555555555555
55555555555555555555555555555555555556666666666666666666666666666666666666666666666666666665555555555555555555555555555555555555
55555555555555555555555555555555555666666666666666666666666666666666666666666666666666666666655555555555555555555555555555555555
55555555555555555555555555555555566666666666666666666666666666666666666666666666666666666666666555555555555555555555555555555555
55555555555555555555555555555556666666666666666666666666666666666666666666666666666666666666666665555555555555555555555555555555
55555555555555555555555555555566666666666666666666666666666666666666666666666666666666666666666666555555555555555555555555555555
55555555555555555555555555556666666666666666666666666666666666666666666666666666666666666666666666665555555555555555555555555555
55555555555555555555555555566666666666666666666666666666666666666666666666666666666666666666666666666555555555555555555555555555
55555555555555555555555555666666666666666666666666666666666666666666666666666666666666666666666666666665555555555555555555555555
55555555555555555555555566666666666666666666666666666666666666666666666666666666666666666666666666666666555555555555555555555555
55555555555555555555555666666666666666666666666666666666666666666666666666666666666666666666666666666666655555555555555555555555
55555555555555555555556666666666666666666666666666666666666666666666666666666666666666666666666666666666665555555555555555555555
55555555555555555555566666666666666666666666666666666666666666666666666666666666666666666666666666666666666555555555555555555555
55555555555555555555666666666666666666666666666666666666666666666666666666666666666666666666666666666666666655555555555555555555
55555555555555555556666666666666666666666666666666666666666666666666666666666666666666666666666666666666666665555555555555555555
55555555555555555566666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666555555555555555555
55555555555555555666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666655555555555555555
55555555555555556666666666666666666666666777777777777777666666666666666666666666666666666666666666666666666666665555555555555555
55555555555555566666666666666666666777777777777777777777777776666666666666666666666666666666666666666666666666666555555555555555
55555555555555666666666666666666777777777777777777777777777777777666666666666666666666666666666666666666666666666655555555555555
55555555555555666666666666666777777777777777777777777777777777777776666666666666666666666666666666666666666666666665555555555555
55555555555556666666666666777777777777777777777777777777766777777777776666666666666666666666666666666666666666666665555555555555
55555555555566666666666677777777777777777777777777776666665566666777777766666666666666666666666666666666666666666666555555555555
55555555555666666666667777777777777777777777777776666666567555666667777777666666666666666666666666666666666666666666655555555555
55555555555666666666677777777777777777777777777666666655667765556666677777776666666666666666666666666666666666666666655555555555
55555555556666666667777777777777777777777777766666666555675566656666666777777666666666666666666666666666666666666666665555555555
55555555566666666677777777777777777777777776666666665555676667766666666677777776666666666666666666666666666666666666666555555555
55555555566666667777777777777777777777777766666666665555675076666566666667777777666666666666666666666666666666666666666555555555
55555555666666677777777777777777777777777666666666655556776767676656666666777777766666666666666666666666666666666666666655555555
55555555666666777777777777777777777777766666666666555556765766577655666666677777776666666666666666666666666666666666666655555555
55555556666667777777777777777777777777666666666665555567550606767655566666667777777666666666666666666666666666666666666665555555
55555556666677777777777777777777777776666666666655555665066007666765555666666777777766666666666666666666666666666666666665555555
55555566666777777777777777777777777766666666666555566767770000765665555566666777777776666666666666666666666666666666666666555555
55555566667777777777777777777777776666666666665556667767700000055676555555666677777777666666666666666666666666666666666666555555
55555666677777777777777777777777766666666666555666677665600000056676655555566667777777766666666666666666666666666666666666655555
55555666777777777777777777777777666666666655566666777656500000000667666665556667777777776666666666666666666666666666666666655555
55555666777777777777777777777776666666666556776567765567500000067566776666675666777777777666666666666666666666666666666666655555
55556667777777777777777777777766666666555567567755500765600000076566767777656566777777777666666666666666666666666666666666665555
55556677777777777777777777777666666655555667660656700600000000000065076666507656677777777766666666666666666666666666666666665555
55556677777777777777777777766666665555556667050007660000000000000000066765757756677777777766666666666666666666666666666666665555
55566777777777777777777777666665555555566676560000000000000000000000005000657755667777777776666666666666666666666666666666666555
55566777777777777777777766666555555555666676550000000000000000000000006000066655667777777777666666666666666666666666666666666555
55567777777777777777777666555555555556666765665000000000000000000000000000006655667777777777666666666666666666666666666666666555
55667777777777777777766655555555555566667667500000000000000000000000000000757665566777777777666666666666666666666666666666666655
55677777777777777776665666655555556666676600000000000000000000000000000000657765566777777777766666666666666666666666666666666655
55677777777777776666657566666666666677776660000000000000000000000000000000006675566677777777766666666666666666666666666666666655
55677777777776666665566576777775777777766665000000000000000000000000000000057666566677777777776666666666666666666666666666666655
55777777776666666655566665677660567776666600000000000000000000000000000000000766566677777777776666666666666666666666666666666655
56777777666666665555667567765565656565557600000000000000000000000000000000000666566677777777776666666666666666666666666666666665
56777766666666655555667665676655057755566500000000000000000000000000000000007676566667777777777666666666666666666666666666666665
57777666666666555555677656600570057767776000000000000000000000000000000000000576566667777777777666666666666666666666666666666665
57776666666665555555677556600000000005660000000000000000000000000000000000000566566667777777777666666666666666666666666666666665
57766666666655555556776675700000000000760000000000000000000000000000000000000075566667777777777666666666666666666666666666666665
57666666666555555566665550000000000000050000000000000000000000000000000000005665566667777777777666666666666666666666666666666665
57666666665555666765556650000000000000050000000000000000000000000000000000006665566667777777777666666666666666666666666666666665
56666666655666667756665600000000000000000000000000000000000000000000000000006765566666777777777766666666666666666666666666666665
56655566566666777657566600000000000000000000000000000000000000000000000000076665566666777777777766666666666666666666666666666665
55556676777776666676500000000000000000000000000000000000000000000000000000757655566666777777777766666666666666666666666666666665
56576665655656665576000000000000000000000000000000000000000000000000000007667655566666777777777766666666666666666666666666666666
56577655655656665576000000000000000000000000000000000000000000000000000007667655566666777777777766666666666666666666666666666666
55556676777776666676600000000000000000000000000000000000000000000000000000557655566666777777777766666666666666666666666666666665
56655565566666777657676600000000000000000000000000000000000000000000000000076665566666777777777766666666666666666666666666666665
56666666655666667756665600000000000000000000000000000000000000000000000000006765566666777777777766666666666666666666666666666665
57666666665555666765556650000000000000050000000000000000000000000000000000006665566667777777777666666666666666666666666666666665
57666666666555555566665500000000000000050000000000000000000000000000000000005665566667777777777666666666666666666666666666666665
57766666666655555556776675700000000000760000000000000000000000000000000000000075566667777777777666666666666666666666666666666665
57776666666665555555677556600000000005660000000000000000000000000000000000000566566667777777777666666666666666666666666666666665
57777666666666555555677656600500006707776000000000000000000000000000000000000576566667777777777666666666666666666666666666666665
56777766666666655555667665676655057755566500000000000000000000000000000000007676566667777777777666666666666666666666666666666665
56777777666666665555667567765566656565557600000000000000000000000000000000000666566677777777776666666666666666666666666666666665
55777777776666666655566665677666567776666600000000000000000000000000000000000766566677777777776666666666666666666666666666666655
55677777777776666665566576777765777777766665000000000000000000000000000000057676566677777777776666666666666666666666666666666655
55677777777777776666657566666666666677776660000000000000000000000000000000066675566677777777766666666666666666666666666666666655
55677777777777777776665666655555556666676600000000000000000000000000000000657765566777777777766666666666666666666666666666666655
55667777777777777777766655555555555566667667500000000000000000000000000000657665566777777777666666666666666666666666666666666655
55567777777777777777777666555555555556666765665000000000000000000000000000006655667777777777666666666666666666666666666666666555
55566777777777777777777766666555555555666676560000000000000000000000006000065655667777777777666666666666666666666666666666666555
55566777777777777777777777666665555555566676560000000000000000000000005000667755667777777776666666666666666666666666666666666555
55556677777777777777777777766666665555556667050007660000000000000000066775707756677777777766666666666666666666666666666666665555
55556677777777777777777777777666666655555667660656700600000000000055076666507656677777777766666666666666666666666666666666665555
55556667777777777777777777777766666666555567067655550765600000076566667777656566777777777666666666666666666666666666666666665555
55555666777777777777777777777776666666666556776567765567500000067566776666675666777777777666666666666666666666666666666666655555
55555666777777777777777777777777666666666655566666777656500000006667666665556667777777776666666666666666666666666666666666655555
55555666677777777777777777777777766666666666555666677665600000066676655555566667777777766666666666666666666666666666666666655555
55555566667777777777777777777777776666666666665556667767600000055676555555666677777777666666666666666666666666666666666666555555
55555566666777777777777777777777777766666666666555566766670000665665555566666777777776666666666666666666666666666666666666555555
55555556666677777777777777777777777776666666666655555665066007666765555666666777777766666666666666666666666666666666666665555555
55555556666667777777777777777777777777666666666665555567550706767655566666667777777666666666666666666666666666666666666665555555
55555555666666777777777777777777777777766666666666555556765766577655666666677777776666666666666666666666666666666666666655555555
55555555666666677777777777777777777777777666666666655556776767676656666666777777766666666666666666666666666666666666666655555555
55555555566666667777777777777777777777777766666666665555675676766566666667777777666666666666666666666666666666666666666555555555
55555555566666666677777777777777777777777776666666665555676667766666666677777776666666666666666666666666666666666666666555555555
55555555556666666667777777777777777777777777766666666555675566656666666777777666666666666666666666666666666666666666665555555555
55555555555666666666677777777777777777777777777666666655666765556666677777776666666666666666666666666666666666666666655555555555
55555555555666666666667777777777777777777777777776666665567555666667777777666666666666666666666666666666666666666666655555555555
55555555555566666666666677777777777777777777777777776666665566666777777766666666666666666666666666666666666666666666555555555555
55555555555556666666666666777777777777777777777777777777766677777777776666666666666666666666666666666666666666666665555555555555
55555555555556666666666666666777777777777777777777777777777777777776666666666666666666666666666666666666666666666665555555555555
55555555555555666666666666666666777777777777777777777777777777777666666666666666666666666666666666666666666666666655555555555555
55555555555555566666666666666666666777777777777777777777777776666666666666666666666666666666666666666666666666666555555555555555
55555555555555556666666666666666666666666777777777777777666666666666666666666666666666666666666666666666666666665555555555555555
55555555555555555666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666655555555555555555
55555555555555555566666666666666666666666666666666666666666666666666666666666666666666666666666666666666666666555555555555555555
55555555555555555556666666666666666666666666666666666666666666666666666666666666666666666666666666666666666665555555555555555555
55555555555555555555666666666666666666666666666666666666666666666666666666666666666666666666666666666666666655555555555555555555
55555555555555555555566666666666666666666666666666666666666666666666666666666666666666666666666666666666666555555555555555555555
55555555555555555555556666666666666666666666666666666666666666666666666666666666666666666666666666666666665555555555555555555555
55555555555555555555555666666666666666666666666666666666666666666666666666666666666666666666666666666666655555555555555555555555
55555555555555555555555566666666666666666666666666666666666666666666666666666666666666666666666666666666555555555555555555555555
55555555555555555555555556666666666666666666666666666666666666666666666666666666666666666666666666666665555555555555555555555555
55555555555555555555555555566666666666666666666666666666666666666666666666666666666666666666666666666555555555555555555555555555
55555555555555555555555555556666666666666666666666666666666666666666666666666666666666666666666666665555555555555555555555555555
55555555555555555555555555555566666666666666666666666666666666666666666666666666666666666666666666555555555555555555555555555555
55555555555555555555555555555556666666666666666666666666666666666666666666666666666666666666666665555555555555555555555555555555
55555555555555555555555555555555566666666666666666666666666666666666666666666666666666666666666555555555555555555555555555555555
55555555555555555555555555555555555666666666666666666666666666666666666666666666666666666666655555555555555555555555555555555555
55555555555555555555555555555555555556666666666666666666666666666666666666666666666666666665555555555555555555555555555555555555
55555555555555555555555555555555555555566666666666666666666666666666666666666666666666666555555555555555555555555555555555555555
55555555555555555555555555555555555555555566666666666666666666666666666666666666666666555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555566666666666666666666666666666666666666555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555566666666666666666666666666666666555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555666666666666666666666655555555555555555555555555555555555555555555555555555
55555555555555555555555555555555555555555555555555555555555555566555555555555555555555555555555555555555555555555555555555555555

