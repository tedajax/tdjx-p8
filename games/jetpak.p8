pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
#include util.p8

function _init()

	world={
		h=1,b=0,bh=nil,
		nob=0,
		page=0,
	}
	_face_t={-1,1}
	gen_world(0,15,true)
	gen_world(16,31)

	p={
		x=64,y=64,dx=1,dy=0,
		ddx=0,ddy=0.1,
		face=1,
		face_r=0.4,
		turn_sgn=0,
		thrust_power=0.3,
		thrust=0,
		sp=32,
	}
	
	actors={}
	add(actors,p)
	enemies={}
	
	for i=1,10 do
		local a={
			id=i,
			x=flr(rnd(128)),y=flr(rnd(48)),
			dx=0,dy=0,
			ddx=0,ddy=0,
			t0=flr(rnd(8))+8,
			sp=4
		}
		add(actors,a)
		add(enemies,a)
	end
	
end

function s2w(sx,sy)
	return flr(sx/8-world.page*16),
		flr(sy/8)
end

function _update()
	local ix,iy=0,0
	local pid=0
	
	if (btn(0,pid)) ix-=1
	if (btn(1,pid)) ix+=1
	if (btn(2,pid)) iy-=1
	if (btn(3,pid)) iy+=1
	
	if p.turn_sgn==0 then
		if (ix~=0) p.turn_sgn=sgn(ix)
	else
		p.face+=p.turn_sgn*p.face_r
		if p.face<-1 then
			p.face=-1
			p.turn_sgn=0
		elseif p.face>1 then
			p.face=1
			p.turn_sgn=0
		end
	end
	
	p.thrust=-iy
	
	if p.thrust>0 then
		p.dy-=p.thrust_power*p.thrust
	end
	
	--[[
	if btnp(1) then
		p.dx=8
	else
		p.dx=0
	end]]
	foreach(enemies,function(self)
		self.face=self.face or 1
		self.t=self.t or self.t0
		self.dx+=0.05*self.face
		if self.dx>1 then
			self.dx=1
			self.t-=1
		end
		if self.dx<-1 then
			self.dx=-1
			self.t-=1
		end
		if self.t<=0 then
			self.face*=-1
			self.t=nil
		end
	end)
	
	foreach(actors,move_actor)
		
	if p.x>=(world.page+1)*128+64 then
		move_world(0,16,16)
		gen_world(16,31,false)
		world.page+=1
	end
	
	local wx,wy=s2w(p.x,p.y)

	if fget(mget(wx,wy),0) then
		stop()
	end	
end

function _draw()
	cls(1)
	
	camera(0,0)
	
	-- draw player
	local px=64
	local sp=p.sp+p.face+1.5
	spr(sp,px-3,p.y-3)
	
	if p.thrust>0 then
		if flr(sp)==p.sp then
			pset(px+4,p.y+3,8)
		elseif flr(sp)==p.sp+2 then
			pset(px-3,p.y+3,8)
		end
	end
	
	-- draw enemies
	foreach(enemies,draw_enemy)

	-- draw world
	map(0,0,-p.x+64+world.page*128,0,32,16)
		
	camera()
	
	-- minimap
--	map_mode="paged"
	map_mode="dynamic"
	if map_mode=="paged" then
		local wx,wy=s2w(p.x,p.y)
		local mpx,mpy=1,111
		rectfill(mpx,mpy,mpx+31,mpy+15,0)
		line(mpx+wx-9,mpy,mpx+wx-9,mpy+15,2)
		line(mpx+wx+8,mpy,mpx+wx+8,mpy+15,2)
		rectfill(mpx+wx-8,mpy,mpx+wx+7,mpy+15,1)
		rect(mpx-1,mpy-1,mpx+32,mpy+16,12)
		for x=0,31 do
			for y=0,15 do
				if fget(mget(x,y),0) then
					pset(mpx+x,mpy+y,5)
				end
			end
		end
		if wy>=0 and wy<16 then
			pset(mpx+wx,mpy+wy,7)
		end
	elseif map_mode=="dynamic" then
		local wx,wy=s2w(p.x,p.y)
		local c=16
		local mpx,mpy=1,111
		rectfill(mpx,mpy,mpx+31,mpy+15,0)
		line(mpx+c-9,mpy,mpx+c-9,mpy+15,2)
		line(mpx+c+8,mpy,mpx+c+8,mpy+15,2)
		rectfill(mpx+c-8,mpy,mpx+c+7,mpy+15,1)
		rect(mpx-1,mpy-1,mpx+32,mpy+16,12)
		for x=0,31 do
			for y=0,15 do
				if fget(mget((x+wx+16)%32,y),0) then
					pset(mpx+x,mpy+y,5)
				end
			end
		end
		if wy>=0 and wy<16 then
			pset(mpx+c,mpy+wy,7)
		end
	end
	
	draw_watches()
	draw_log()
end

function draw_enemy(self)
	local face=(mid(self.dx,-1,0x0.ffff)+1)/2
	local sp=self.sp+face*4
	spr(sp,self.x-3,self.y-3)
end
-->8
-- world

function gen_world(x0,x1,flat)
	for x=x0,x1 do
		for y=0,15 do mset(x,y,0) end
	
		local rough=0.3
		if (flat) rough=0
		if rnd()<rough then
			local d=_face_t[flr(rnd(2))+1]
			world.h=mid(world.h+d,0,3)
		end
		
		if world.b>0 then
			world.b-=1
			if (world.b<=0) world.bh=nil
		end
		
		local bperc=0.25
		if (flat) bperc=0
		if (world.nob>0) world.nob-=1
		if world.b==0 and rnd()<bperc and world.nob<=0 then
			world.b=flr(rnd(2))+2
			_bh={5,5,5,
				6,6,6,6,7,7,7,7,8,8,9}
			local bhi=flr(rnd(#_bh))+1
			world.bh=_bh[bhi]
			world.nob=8+flr(rnd(8))
		end
		
		local top=15-(world.bh or world.h)
		for y=15,top,-1 do
			local s=24
			if (y==top) s=8
			mset(x,y,s)
		end
	end
end

function move_world(dstx,srcx,w)
	for x=0,w-1 do
		for y=0,15 do
			mset(dstx+x,y,mget(srcx+x,y))
		end
	end
end


-->8
-- actors

function move_actor(self)
	self.dx+=self.ddx
	self.dy+=self.ddy
	self.x+=self.dx
	self.y+=self.dy
	
	self.wx=flr(self.x/8-world.page*16)
	self.wy=flr(self.y/8)
end
__gfx__
0000000000000000000000000000000000000000008008000080080000000000bbbbbbbb00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000880880008888000088880008808800bbbbbbbb00000000000000000000000000000000000000000000000000000000
007007000000000000000000000000000888880008eeee8008eeee8000888880bbbbbbbb00000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000eeeee88808eeee8008eeee80888eeeee44bb44b400000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000e8e8ee800e8e8e8088e8e8e008ee8e8e4bb44b4400000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000eeeeee800eeeee8008eeeee008eeeeeeb44b444400000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000088888880888888008888880888888804444444400000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000888000008808888088000008880004444444400000000000000000000000000000000000000000000000000000000
00666000000660000006660000000000000000000000000000000000000000004444444400000000000000000000000000000000000000000000000000000000
06666c000066660000c6666000000000000000000000000000000000000000004444444400000000000000000000000000000000000000000000000000000000
0cccccddddc66cddddccccc000000000000000000000000000000000000000004444444400000000000000000000000000000000000000000000000000000000
00cc99ddd4cccc4ddd99cc0000000000000000000000000000000000000000004444444400000000000000000000000000000000000000000000000000000000
999999dd99cccc99dd99999900000000000000000000000000000000000000004444444400000000000000000000000000000000000000000000000000000000
49cccc0d99cccc99d0cccc9400000000000000000000000000000000000000004444444400000000000000000000000000000000000000000000000000000000
0ddcdd000ddccdd000ddcdd000000000000000000000000000000000000000004444444400000000000000000000000000000000000000000000000000000000
0dd0dd000dd00dd000dd0dd000000000000000000000000000000000000000004444444400000000000000000000000000000000000000000000000000000000
00666000000660000006660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06666d000066660000d6666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0dddddaa9ad66da9aaddddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00ddaa9a99dddd99a9aadd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaaaa99aaaddddaaa99aaaaa00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9adddd0aaaddddaaa0dddda900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
066d6600066dd6600066d66000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06606600066006600066066000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000010000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
