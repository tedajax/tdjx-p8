pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
#include util.p8

function add_entity(ent)
	return add(entities,ent)
end

function _init()
	entities={}

	palettes={
		default={
			0,7,8
		},
		amiga={
			1,7,9
		}
	}

	palette=palettes.amiga

	player={
		x=64,
		y=116,
		dx=0,dy=0,
		w=8,h=8,
		face=0,
		sp=16,
		t_fire=0,
		fire_ivl=0.18
	}
	
	glob={
		speed=0
	}
	
	wall_lines={}
	wall_buff=16
	wall_len=wall_buff*2+128
	line_ct=8
	for i=0,line_ct-1 do
		local y=i*flr(wall_len/line_ct)
		add(wall_lines,y)
	end
	
	river_w=116
end

function _update()
	dt=fps30_dt

	clear_watches()

	if (glob.speed<60) glob.speed+=10*dt


	local ix,iy=input_xy()
	
	local accel=200


	if ix~=0 then
		if sgn(ix)~=sgn(player.dx) then
			accel*=2
		end
		player.dx+=ix*accel*dt
		player.dx=mid(player.dx,
			-100,100)
	else
		if player.dx<0 then
			player.dx=min(player.dx+accel*dt,0)
		else
			player.dx=max(player.dx-accel*dt,0)
		end
	end
	
	player.face=sgn(ix)
	
	player.x+=player.dx*dt
	player.y+=player.dy*dt

	river_w=84
	
	local left=flr(64-river_w/2)
	local right=flr(64+river_w/2)
	
	if player.x<left+8 then
		player.x=left+8
		if (player.dx<0) player.dx=0
	elseif player.x>right-7 then
		player.x=right-7
		if (player.dx>0) player.dx=0
	end
	
	if (player.t_fire>0) player.t_fire-=dt
	
	if btn(4) then
		if player.t_fire<=0 then
			player.t_fire=player.fire_ivl
			add_entity(bullet:new({x=player.x-5,y=player.y+2,t_life=2,dy=-160}))
			add_entity(bullet:new({x=player.x+5,y=player.y+2,t_life=2,dy=-160}))
		end
	else
		player.t_fire=0
	end
	
	foreach(entities,function(e)
		if e.update then
			e:update(dt)
		end
	end)
	
	for i=1,line_ct do
		wall_lines[i]+=glob.speed*dt
		if wall_lines[i]>=128+wall_buff then
			wall_lines[i]-=wall_len
		end
	end
end

function _draw()
	cls(palette[1])
	
	for i=1,#palettes.default do
		pal(palettes.default[i],palette[i])
	end
	
	spr(2,56,20,8,1)
	
	local sp=player.sp
	
	spr(sp,player.x-player.w,
		player.y-player.h,2,2)
		
		
	local left=flr(64-river_w/2)
	local right=ceil(64+river_w/2)
	rectfill(0,0,left,127,6)
	rectfill(right,0,127,127,6)
	line(left,0,left,127,7)
	line(right,0,right,127,7)
	
	foreach(entities,function(e)
		if e.draw then
			e:draw()
		end
	end)
	
	for l in all(wall_lines) do
		line(0,l,left,l,7)
		line(right,l,127,l,7)
	end
	
	draw_watches()
end

entity=class({
	x=0,y=0,w=0,h=0,
})

bullet=class({
	extends=entity,
	dx=0,dy=0,
	w=1,h=3,
	t_life=0,
})

function bullet:update(dt)
	if self.t_life>0 then
		self.t_life-=dt
		if self.t_life<=0 then
			del(entities,self)
		end
	end

	self.x+=self.dx*dt
	self.y+=self.dy*dt
end

function bullet:draw()
	local x1,y1=topleft(self)
	spr(18,x1,y1)
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000008888888888888888888888888888888888888888888888888888888888888888000000000000000000000000000000000000000000000000
00700700000000000088008800880088008800880088008800880088008800880088008800880088000000000000000000000000000000000000000000000000
00077000000000000880088008800880088008800880088008800880088008800880088008800880000000000000000000000000000000000000000000000000
00077000000000008800880088008800880088008800880088008800880088008800880088008800000000000000000000000000000000000000000000000000
00700700000000008008800880088008800880088008800880088008800880088008800880088008000000000000000000000000000000000000000000000000
00000000000000008888888888888888888888888888888888888888888888888888888888888888000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000007700000008800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000077770000008800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000778877000007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000788887000007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007788887700007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007788887700007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777777777777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00777777777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007707707700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
