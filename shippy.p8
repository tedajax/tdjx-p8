pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
	dt=0x0000.0444

	for xx=0,127 do
		for yy=0,63 do
			if mget(xx,yy)==16 then
				mset(xx,yy,0)
				ship=actor:new({
					x=xx,y=yy,
					sp=16,id=0,face=1,
					t_fire=0,fire_ivl=0.19})
			end
		end
	end
	
	cam_x=ship.x
	
	bullets={}
	bullet_n=8
	bullet_idx=1
	for i=1,bullet_n do
		add(bullets,
			actor:new({
				x=0,y=0,
				sp=32,
				on=false,
			}))
	end
	
	effects={}
	
	enemies={}
	
	for i=1,8 do
		local ex,ey=random_pos(0,0,32,16)
		add(enemies,actor:new({
			x=ex+0.5,y=ey+0.5,
			rot=0,rad=0.4,
		}))
	end
end

function random_pos(x,y,w,h)
	local px,py=0,0
	repeat
		px=flr(rnd(w))+x
		py=flr(rnd(h))+y
	until not solid(px,py)
	return px,py
end

function _update60()
	ship_control(ship,dt)
	foreach(bullets,function(b)
		bullet_update(b)
	end)
	
	foreach(effects,function(fx)
		fx.t+=dt
		fx.nt=fx.t/fx.dur
		if fx.t>=fx.dur then
			del(effects,fx)
		end
	end)
	
	local t_cam_x=ship.x
	if ship.dx~=0 then
		t_cam_x+=ship.face*2+ship.dx
	end
	local lerp=function(a,b,t)
		return (b-a)*t+a
	end
	cam_x=lerp(cam_x,t_cam_x,0.15)
	cam_x=mid(cam_x,8,24)
end

function _draw()
	cls(1)

	local cwx,_=w2s(cam_x,0)	
	camera(cwx-64,0)
	
	map(0,0,0,0,32,16)
	draw_actor(ship)
	foreach(bullets,function(b)
		if b.on then
			draw_actor(b)
		end
	end)
	
	foreach(enemies,function(e)
		local ex,ey=e.x*8,e.y*8
		circfill(ex,ey,e.rad*8,8)
		local lx,ly=cos(e.rot)*3+ex,
			sin(e.rot)*3+ey
		line(ex,ey,lx,ly,10)
	end)
	
	foreach(effects,function(fx)
		fx:draw()
	end)
	
	camera()
	
	if solid(ship.x,ship.y) then
		rectfill(0,0,3,3,8)
	end
end

function w2s(x,y)
	return x*8,y*8
end

function input_xy(pid)
	pid=pid or 0
	local ix,iy=0,0
	if (btn(0,pid)) ix-=1
	if (btn(1,pid)) ix+=1
	if (btn(2,pid)) iy-=1
	if (btn(3,pid)) iy+=1
	return ix,iy
end

function fire_bullet(x,y,dx,life)
	local i=bullet_idx
	
	if bullets[i].on then
		return
	end
	
	bullet_idx+=1
	if bullet_idx>bullet_n then
		bullet_idx=1
	end
	
	local bullet=bullets[i]
	
	bullet.on=true
	bullet.x=x
	bullet.y=y
	bullet.dx=dx
	bullet.t=life or 10
end

function bullet_update(self)
	if not self.on then
		return
	end
	
	self.x+=self.dx
	self.t-=1
	
	if self.t<=0 or solid(self.x,self.y) then
		self.on=false
		add_spark(self.x-self.dx,self.y)
	end
end

function ship_control(self)
	local ix,iy=input_xy(self.id)
	
	self.dx+=0.02*ix
	local maxspd=0.125
	self.dx=mid(self.dx,-maxspd,maxspd)
	self.dy=iy*0.125
	
	if ix==0 then
		local decay=0.001
		if ship.dx<0 then
			ship.dx=min(ship.dx+decay,0)
		elseif ship.dx>0 then
			ship.dx=max(ship.dx-decay,0)
		end
	end
	
	if self.dx>0 then
		while solid(self.x+self.dx+0.375,self.y)
			and self.dx>0
		do
			self.dx=max(self.dx-0.125,0)
		end
	elseif self.dx<0 then
		while solid(self.x+self.dx-0.5,self.y)
			and self.dx<0
		do
			self.dx=min(self.dx+0.125,0)
		end
	end
	
	if self.dy>0 then
		while solid(self.x,self.y+self.dy+0.25)
			and self.dy>0
		do
			self.dy=max(self.dy-0.125,0)
		end
	elseif self.dy<0 then
		while solid(self.x,self.y+self.dy-0.375)
			and self.dy<0
		do
			self.dy=min(self.dy+0.125,0)
		end
	end
	
	self.x+=self.dx
	self.y+=self.dy
	
	if ix<0 then
		self.face=-1
	elseif ix>0 then
		self.face=1
	end
	
	self.t_fire-=dt
	
	if btn(4,self.id) then
		if self.t_fire<=0 then
			fire_bullet(self.x-self.face*0.125,
				self.y+0.125,
				self.face*0.6,
				30)
			self.t_fire=self.fire_ivl
		end
	else
		self.t_fire=0
	end
end

function draw_actor(self)
	if self.sp then
		local px,py=w2s(self.x,self.y)
		px-=self.w*8
		py-=self.h*8
		local flipx=false
		if self.face and self.face<0 then
			flipx=true
		end
		spr(self.sp,px,py,1,1,flipx)
	end
end

actor={
	x=0,y=0,w=0.5,h=0.5,
	dx=0,dy=0,
	t=0
}

function actor:new(param)
	self.__index=self
	return setmetatable(param or {},
		self)
end

function solid(x,y)
	return fget(mget(x,y),0)
end

function add_spark(x,y)
	return add(effects,{
		x=x,y=y,
		t=0,nt=0,dur=0.35,
		draw=function(self)
			local v=self.nt*1.8
			local rad=cos(v)*v*2+v+1
			circ(self.x*8,self.y*8,rad,10)
		end,
	})
end
__gfx__
0000000000000000000000000000000000000000000000000000000000000000eeeeeeee00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000e22ee22e00000000000000000000000000000000000000000000000000000000
0070070000000000000000000000000000000000000000000000000000000000e22ee22e00000000000000000000000000000000000000000000000000000000
0007700000000000000000000000000000000000000000000000000000000000eeeeeeee00000000000000000000000000000000000000000000000000000000
0007700000000000000000000000000000000000000000000000000000000000eeeeeeee00000000000000000000000000000000000000000000000000000000
0070070000000000000000000000000000000000000000000000000000000000e22ee22e00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000e22ee22e00000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000eeeeeeee00000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
660cc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66cccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06666555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9aaaaaa9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
9aaaaaa9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0808080808080808080808080808080808080808080808080808080808080808000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000080808080000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000808080800000000001000000000000008080808000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000808080800000000000000000000000008080808000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0800000000000000000000000000080808080000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0808080808080808080808080808080808080808080808080808080808080808000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
