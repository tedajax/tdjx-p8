pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- kromatique
--    tdjx

colors={{ptn=0x0000,col=0x08},
	{ptn=0x1248,col=0x1c},
	{ptn=0xf0f0,col=0x3b},
	{ptn=0xa0a0,col=0x9a}
}

function _init()
	plr={}
	plr.x=2
	plr.y=64
	plr.w=8
	plr.h=8
	plr.col=1
	plr.chgmx=7
	plr.chgf=0
	plr.lzrt,plr.lzrb=0,0
	
	blocks={}
	for i=0,199 do
		add(blocks,{
			x=rnd(90)+27,
			y=rnd(128),
			dx=0,
			dy=rnd(2),
			col=flr(rnd(4))+1,
			hw=4,
			hh=4
		})
	end
end

function _update()
	local dy=0
	if (btn(2)) dy-=1
	if (btn(3)) dy+=1
	plr.y+=dy*4
	plr.y=clamp(plr.y,5,122)
	
	if btn(4) then
		plr.chgf+=1
		plr.chgf=min(plr.chgf,
			plr.chgmx)
	else
		plr.chgf-=1
		plr.chgf=max(plr.chgf,0)
	end
	
	if btnprs(5) then
		plr.col+=1
		if plr.col>#colors then
		 plr.col=1
		end
	end
	
	for blk in all(blocks) do
		blk.x+=blk.dx
		blk.y+=blk.dy
		
		if blk.y>133 then
			blk.y=-8
			blk.x=rnd(90)+27
			blk.dy=rnd(2)
		end
	end
	
	btnupdate()
end

function _draw()
	cls()
	
	rectfill(plr.x,plr.y-plr.h/2,
		plr.x+plr.w,plr.y+plr.h/2,7)
		
	ptncolor(plr.col)
	rectfill(plr.x+plr.w/4,
		plr.y-plr.h/4,
		plr.x+plr.w/4*3,plr.y+plr.h/4)

	fillp()		
	for blk in all(blocks) do
		rectfill(blk.x-blk.hw,
 			blk.y-blk.hh,
 			blk.x+blk.hw,
 			blk.y+blk.hh,
 			6)
	end

	for blk in all(blocks) do
		if blk_covered(blk,plr)	and
			blk.col==plr.col
		then
			local ty=max(blk.y-blk.hh,
				plr.lzrt)
			local by=min(blk.y+blk.hh,
				plr.lzrb)
			ptncolor(blk.col)
			rectfill(blk.x-blk.hw,ty,
				blk.x+blk.hw,by)
 	end
	end

	if plr.chgf>0 then
		local frac=plr.chgf/plr.chgmx
		local x1=plr.x+10
		local x2=x1+lerp(0,127-x1,
			clamp01(frac*4))
		local h=lerp(0,80,frac)
		local y1=plr.y-h/2
		local y2=plr.y+h/2
		plr.lzrt=y1
		plr.lzrb=y2
		fillp()
		rect(x1,y1,x2,y2,
			colors[plr.col].col)
	end
end

function ptncolor(pc)
	local v=colors[pc]
	fillp(v.ptn)
	color(v.col)
end

function blk_covered(blk,plr)
	return plr.chgf>0 and
		plr.lzrt<=blk.y+blk.hh and
		plr.lzrb>=blk.y-blk.hh
end

function lerp(a,b,t)
	return a+(b-a)*t
end

function clamp(v,mn,mx)
	return max(min(v,mx),mn)
end

function clamp01(v)
	return clamp(v,0,1)
end

_btns={}
function btnupdate()
	for i=0,5 do
		_btns[i]=btn(i)
	end
end

function btnprs(b)
	return btn(b) and not _btns[b]
end

function btnrel(b)
	return not btn(b) and _btns[b]
end
__label__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000088888888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000999999999888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000999999999888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000999999999888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000999999999888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000999999999888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000999999999888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000999999999888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000999999999888800000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000999999999000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbb00000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbb0000000000000000000bbbbbbbbb00aaaaaaaaa00000
0000000000000000000000000000000000000000000000000000bbbbbbbbb00000000000000bbbbbbbbb0000000000000000000bbbbbbbbb00aaaaaaaaa00000
0000000000000000000000000000000000000000000000000000bbbbbbbbb00000000000000bbbbbbbbb0000000000000000000bbbbbbbbb00aaaaaaaaaeeeee
0000000000000000000000000000000000000000000000000000bbbbbbbbb00000000000000bbbbbbbbb0000000000000000000bbbbbbbbb00aaaaaaaaaeeeee
0000000000000000000000000000000000000000000000000000bbbbbbbbb00000000000000bbbbbbbbb00000000000000bbbbbbbbbbbbbb00aaaaaaaaaeeeee
0000000000000000000000000000000000000000000000000000bbbbbbbbb00000000000000bbbbbbbbb00000000000000bbbbbbbbbbbbbb00aaaaaaaaaeeeee
0000000000000000000000000000000000000000000000000000bbbbbbbbb00000000000000bbbbbbbbb00000000000000bbbbbbbbbbbbbb00aaaaaaaaaeeeee
0000000000000000000000000000000000000000000000000000bbbbbbbbb00000000000000bbbbbbbbb00000000000000bbbbbbbbbbbbbb00aaaaaaaaaeeeee
0000000000000000000000000000000000000000000000000000bbbbbbbbb0000000000000000000000000000000000000bbbbbbbbbbbbbb00aaaaaaaaaeeeee
0000000000000000000000000000000000000000000000000000bbbbbbbbb0000000000000000000000000000000000000bbbbbbbbb0000000088888eeeeeeee
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbb0000000088888eeeeeeee
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbb000000008888888880000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbb000000008888888880000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008888888880000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccc00000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccc00000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccc00000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccc00000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccc00000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccc00000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccc00000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ccccccccc00000000000000
000000000000000000000000000000000000000000000000000000000000aaaaaaaaa000000000000000000000000000000000000ccccccccc00000000000000
000000000000000000000000000000000000000000000000000000000000aaaaaaaaa00000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000aaaaaaaaa000000000000000bbbbbbbbb00000000000000000000000000000000000
000000000000000000000000000000000000000000000000099999999900aaaaaaaaa000000000000000bbbbbbbbb00000000000000000000000000000000000
000000000000000000000000000000000000000000000000099999999900aaaaaaaaa000000000000000bbbbbbbbb00000000000000000000000000000000000
000000000000000000000000000000000000000000000000099999999900aaaaaaaaa000000000000000bbbbbbbbb00000000000999999999000000000000000
00000000000088888888888888888888888888888888888880000000008800000000077777777788888800000000088888888888000000000888888888888888
00000000000088888888888888888888888888888888888880000000008800000000077777777788888800000000088888888888000000000888888888888888
00000000000088888888888888888888888888888888888880000000008800000000077777777788888800000000088888888888000000000888888888888888
00000000000088888888888888888888888888888888888880000000008888888888877777777788888800000000088888888888000000000888888888888888
00777777777088888888888888888888888888888888888880000000008888888888877777777788888800000000088888888888000000000888888888888888
00777777777088888888888888888888888888888888888887777777778888888888877777777788888888888888888888888888000000000888888888888888
00778888877088888888888888888888888888888888888887777777778888888888877777777788888888888888888888888888000000000888888888888888
00778888877088888888888888888888888888888888888887777777778888888888877777777788888888888888888888888888000000000888888888888888
00778888877088888888888888888888888888888888888887777777778888888888877777777788888888888888888888888888888888888888888888888888
00778888877088888888888888888888888888888888888887777777778888888888888888888888888888888888888888888888888888888888888888888888
00778888877088888888888888888888888888888888888887777777778888888888888888888888888888888888888888888888888888888888888888888888
00777777777088888888888888888888888888888888888887777777778888888888888888888888888888888888888888888888888888888888888888888888
00777777777088888888888888888888888888888888888887777777778888888888888888888888888888888888888888888888888888888888888888888888
00000000000088888888888888888888888888888888888887777777778888888888888888888888888888888888888888888888888888888888888888888888
00000000000088888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
00000000000088888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
00000000000088888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000aaaaaaaaa000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000aaaaaaaaa000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000aaaaaaaaa000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbaaaaaaaaa000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbaaaaaaaaa000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbaaaaaaaaa000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbaaaaaaaaa000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbaaaaaaaaa000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbaaaaaaaaa000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbb000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbb000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000bbbbbbbbb000000000000000000000000000000000000000000
000000000000000000000000000000000000008888888880000000000000000000000000000000000000000000000000000000aaaaaaaaa00000000000000000
000000000000000000000000000000000000008888888880000000000000000000000000000000000000000000000000000000aaaaaaaaa00000000000000000
000000000000000000000000000000000000008888888880000000000000000000000000000000000000000000000000000000aaaaaaaaa00000000000000000
000000000000000000000000000000000000008888888880000000000000000000000000000000000000000000000000000000aaaaaaaaa00000000000000000
000000000000000000000000000000000000008888888880000000000000000000000000000000000000000000000000000000aaaaaaaaa00000000000000000
000000000000000000000000000000000000008888888880000000000000000000000000000000000000000000000000000000aaaaaaaaa00000000000000000
000000000000000000000000000000000000008888888880000000000000000000000000000000000000000000000000000000aaaaaaaaa00000000000000000
000000000000000000000000000000000000008888888880000000000000000000000000000000000000000000000000000000aaaaaaaaa00000000000000000
000000000000000000000000000000000000008888888880000000000000000000000000000000000000000000000000000000aaaaaaaaa00000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

